---
title: "Working with Transactions"
author: "Mustafa Ascha"
date: "September 11, 2016"
output: html_document
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the last post, we went through the process of simulating some random billing claims data, then putting it through the CSPADE algorithm to see if there were any interesting frequent sequences. 


Before we begin any coding, I'd like to point out that our model will involve considering patients as transactions, and diseases as items. When a patient has a set of diseases, and two of those diseases also occur in many other patients, we'll have an association rule with high "support". For more on understanding association rules, [check out the `arules` package author's document.](http://michael.hahsler.net/research/arules_RUG_2015/demo/) It's a great website, and I highly recommend reading through it. 

## Load libraries, get data

First, of course, we'll have to load some libraries: 

```{r libraries}

library(arules)
library(arulesViz)
library(dplyr)
library(ggplot2)

```

Here's how to make the data we'll use. 

Because this is a simulation, there will be some randomness involved. To make sure you can replicate everything, we'll set a seed: 

```{r set_seed}

set.seed(9001)

```

Making the list of diseases became meditative for me, so I may have added a bit many. Either way, we'll use that to make a dataframe with five patients. 

```{r sim_data}

diseases <- 
	c("Heart_disease",
	  "Hypertension",
	  "Kidney_disease",
	  "Liver_cirrhosis",
	  "Gall_stones",
	  "Kidney_stones",
	  "Tonsiliths",
	  "Unspecified_cancer",
	  "Vitamin_D_deficiency",
	  "Trichtillomania",
	  "Psoriasis",
	  "Esophagitis",
	  "Otitis_media",
	  "Ingrown_toenail",
	  "ADHD",
	  "Arthritis",
	  "Chlamydia",
	  "Parasites_Scabies",
	  "Meningitis",
	  "Zika_Virus",
	  "Hepatitis",
	  "Giardiasis",
	  "Takatsubo_Cardiomyopathy",
	  "Flu",
	  "Obesity",
	  "Latex_allergies",
	  "Lice",
	  "Legionellosis",
	  "Lymphocytic_Choriomeningitis",
	  "Tetanus",
	  "Ticks_Lyme_Disease",
	  "Tuburculosis",
	  "Trench_fever",
	  "Creutzfeldt-Jakob_Disease",
	  "Hearing_loss")

claims_data <- 
	data.frame(disease = sample(diseases, 100, replace = TRUE), 
		   patient = rep_len(1:10, 100), stringsAsFactors = FALSE)

```



## Format data for arules

Given some data, let's prepare it for associations analysis. We'll use the `split` command to produce a list of the diseases that contains a vector of patient identifiers for patients with those diseases.  



Here we go: 

```{r splitit}

claims_tx <- split(claims_data$patient, claims_data$disease)

```

I'll be artificially adding "Hypertension" and "Kidney disease" to several of the patients, just to make sure arules works. ;)


```{r add_association}

claims_tx$Hypertension <- c(claims_tx$Hypertension, 1:3)

claims_tx$Kidney_disease <- c(claims_tx$Kidney_disease, 1:3)

```

Hopefully that will work..

Note that `arules` won't accept "tidLists" with a transaction listed more than once. In our case, that means that patients who have several of the same diagnosis will be considered only in terms of their yes-no disease status. If you're interested in recommender systems that can handle ratings or counts data, I recommend looking into [collaborative filtering approaches](https://en.wikipedia.org/wiki/Netflix_Prize).

```{r make_tidlists}

claims_tx <- lapply(claims_tx, function(x) sort(unique(x)))

claims_tx <- as(claims_tx, "tidLists")

```

## Checking out our data

Even before running the *apriori* or *eclat* algorithms, there's a lot to learn about the data.

Here's R output for when the object, itself, is entered as a command: 

```{r claims_out}

claims_tx

```

That's useful--we know how many items (diagnoses) and how many transactions (patients) we have. 

We can also `inspect` the claims:

```{r claims_inspect}

pander::pander(inspect(claims_tx))

```



The previous table tells us which patients have which diseases. 

For a more extensive list of things to do with `tidLists`, we can use the `methods` function: 

```{r tid_methods}

methods(class = "tidLists")

```

The last exploration we'll do before association analyses will be a visualization: 

```{r image_claims}

image(claims_tx)

```



## Calculate and examine interesting measures

This is healthcare data, so we'll look at tests of difference and odds ratios. 

## networking with these claims

Alright, so let's see what data is available to visualize. I'll just be exploring, here, so let's start with checking out what methods are available for the `rules` class: 

```{r check_methods}

methods(class = "rules")

```




















